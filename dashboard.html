<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSS Smart Dashboard - Final Fix</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #e65100; --accent: #FF6B35; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; background: #000 url('background.jpg') center/cover fixed; }
        .wrapper { display: flex; height: calc(100vh - 110px); }
        .top-nav { height: 60px; background: rgba(255,255,255,0.95); display: flex; justify-content: space-between; align-items: center; padding: 0 25px; border-bottom: 3px solid var(--accent); }
        .main-viewer { flex: 1; padding: 15px; display: flex; flex-direction: column; }
        .content-card { background: white; flex: 1; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .viewer-header { padding: 12px 20px; border-bottom: 1px solid #eee; background: #fafafa; font-weight: bold; color: var(--primary); display: flex; justify-content: space-between; }
        #displayFrame { width: 100%; height: 100%; border: none; background: #fff; }
        #textViewer { padding: 30px; overflow-y: auto; height: 100%; display: none; background: #fff; font-size: 1.1rem; line-height: 1.8; }
        .right-sidebar { width: 210px; background: rgba(255,255,255,0.92); padding: 15px; overflow-y: auto; }
        .info-panel { font-size: 0.8rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc; }
        .step-btn { width: 100%; padding: 10px; margin-bottom: 6px; border: 1px solid #eee; border-radius: 6px; background: #fff; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.8rem; font-weight: 500; transition: 0.2s; }
        .step-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .footer-progress { height: 50px; background: #fff; padding: 0 25px; display: flex; align-items: center; gap: 15px; position: fixed; bottom: 0; width: 100%; border-top: 1px solid #ddd; }
        .p-bar-bg { flex: 1; height: 12px; background: #eee; border-radius: 10px; overflow: hidden; }
        .p-bar-fill { height: 100%; background: linear-gradient(to right, #4CAF50, #81C784); width: 0%; transition: 1s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #loader { position: fixed; inset: 0; background: #fff; display: flex; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body>

<div id="loader"><h2>‡§™‡•ç‡§∞‡§≠‡•Å ‡§∏‡•ç‡§Æ‡§∞‡§£ ‡§ï‡•á ‡§∏‡§æ‡§• ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</h2></div>

<nav class="top-nav">
    <div style="display:flex; align-items:center; gap:10px;">
        <img src="omsss.jpeg" style="height:35px; border-radius:50%; border: 1px solid #ddd;">
        <h4 id="stName">‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞!</h4>
    </div>
    <button onclick="logout()" style="background:#ff4444; color:white; border:none; padding:6px 12px; border-radius:5px; cursor:pointer; font-weight:bold;">Logout</button>
</nav>

<div class="wrapper">
    <main class="main-viewer">
        <div class="content-card">
            <div class="viewer-header">
                <span id="contentTitle">‡§Ö‡§ß‡•ç‡§Ø‡§Ø‡§® ‡§ï‡§ï‡•ç‡§∑</span>
                <span id="chapNo" style="font-size: 0.8rem; color: #666;">‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§ï‡§∞‡•á‡§Ç</span>
            </div>
            <iframe id="displayFrame" src="about:blank" allow="autoplay; fullscreen; encrypted-media"></iframe>
            <div id="textViewer"></div>
        </div>
    </main>

    <aside class="right-sidebar">
        <div class="info-panel" id="sideInfo"></div>
        <button class="step-btn" data-step="1" onclick="loadContent('syllabus', this)"><i class="fas fa-folder-open"></i> üìÇ Syllabus Content</button>
        <div style="margin:15px 0 8px 0; font-size:0.7rem; font-weight:bold; color:#666; text-transform:uppercase;">‡§Ö‡§ß‡•ç‡§Ø‡§Ø‡§® ‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä</div>
        <button class="step-btn" data-step="2" onclick="loadContent('video', this)"><i class="fas fa-play-circle"></i> Video Talk</button>
        <button class="step-btn" data-step="3" onclick="loadContent('pdf', this)"><i class="fas fa-file-pdf"></i> PDF Book</button>
        <button class="step-btn" data-step="4" onclick="loadContent('audio', this)"><i class="fas fa-headphones"></i> Podcast</button>
        <button class="step-btn" data-step="5" onclick="loadContent('slides', this)"><i class="fas fa-chalkboard-teacher"></i> PPT Slides</button>
        <button class="step-btn" data-step="6" onclick="loadContent('summary', this)"><i class="fas fa-file-alt"></i> Summary</button>
        <button class="step-btn" data-step="7" onclick="loadContent('mindmap', this)"><i class="fas fa-project-diagram"></i> Mind Map</button>
        <button class="step-btn" data-step="8" onclick="loadContent('quiz', this)"><i class="fas fa-question-circle"></i> Quiz</button>
        <button class="step-btn" data-step="9" onclick="loadContent('assignment', this)"><i class="fas fa-edit"></i> Assignment</button>
        <button class="step-btn" data-step="10" onclick="loadContent('certificate', this)" style="border: 2px solid var(--accent); margin-top: 10px;">
            <i class="fas fa-award"></i> Certificate
        </button>
    </aside>
</div>

<footer class="footer-progress">
    <span style="font-size:0.8rem; font-weight:bold; color:var(--primary);">‡§™‡•ç‡§∞‡§ó‡§§‡§ø:</span>
    <div class="p-bar-bg"><div class="p-bar-fill" id="progFill"></div></div>
    <span style="font-size:0.8rem; font-weight:bold;" id="progText">0%</span>
</footer>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzrmGKnspyr383f9QzEIKBOknC2s-YreNG18VA7cun0txUnQZOVwGaWHkGPkIvFQzAk/exec';
    let completedSteps = new Set();

    window.onload = function() {
        const email = localStorage.getItem('studentEmail');
        const pass = localStorage.getItem('studentPass');
        fetch(`${scriptURL}?action=login&email=${email}&pass=${pass}`)
        .then(res => res.json()).then(data => {
            document.getElementById('loader').style.display = 'none';
            if(data.result === "success") {
                window.d = data.content;
                document.getElementById('stName').innerText = "‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞, " + data.name + "!";
                document.getElementById('sideInfo').innerHTML = `<b>ID:</b> ${window.d.courseID}<br><b>‡§ï‡•ã‡§∞‡•ç‡§∏:</b> ${window.d.courseName}`;
                document.getElementById('chapNo').innerText = "‡§Ö‡§ß‡•ç‡§Ø‡§æ‡§Ø: " + window.d.lessonNo;
            } else { logout(); }
        }).catch(err => { alert("‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ!"); logout(); });
    };

    function updateProgress(stepId) {
        completedSteps.add(stepId);
        const percentage = Math.round((completedSteps.size / 10) * 100);
        document.getElementById('progFill').style.width = percentage + "%";
        document.getElementById('progText').innerText = percentage + "%";
    }

    function fixDriveLink(url) {
        if (!url || url === "") return "about:blank";
        if (url.includes("drive.google.com")) {
            // ‡§ó‡•Ç‡§ó‡§≤ ‡§°‡•ç‡§∞‡§æ‡§á‡§µ ‡§≤‡§ø‡§Ç‡§ï ‡§∞‡§ø‡§™‡•á‡§Ø‡§∞
            let id = "";
            if (url.includes("id=")) { id = url.split("id=")[1].split("&")[0]; }
            else { id = url.split("/d/")[1].split("/")[0]; }
            return `https://drive.google.com/file/d/${id}/preview`;
        }
        return url;
    }

    function getYouTubeEmbed(url) {
        let videoId = "";
        if (url.includes("v=")) { videoId = url.split("v=")[1].split("&")[0]; }
        else if (url.includes("be/")) { videoId = url.split("be/")[1].split("?")[0]; }
        else { videoId = url.split("/").pop(); }
        return `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&autoplay=1`;
    }

    function loadContent(type, btn) {
        const frame = document.getElementById('displayFrame');
        const textV = document.getElementById('textViewer');
        const title = document.getElementById('contentTitle');
        
        frame.style.display = "block"; textV.style.display = "none";
        frame.src = "about:blank"; // ‡§ï‡•ç‡§≤‡§ø‡§Ø‡§∞ ‡§™‡•ç‡§∞‡•Ä‡§µ‡§ø‡§Ø‡§∏ ‡§´‡•ç‡§∞‡•á‡§Æ

        if(btn) { 
            document.querySelectorAll('.step-btn').forEach(b => b.classList.remove('active')); 
            btn.classList.add('active'); 
            updateProgress(btn.getAttribute('data-step'));
        }

        switch(type) {
            case 'syllabus': title.innerText = "Syllabus Content"; frame.src = fixDriveLink(window.d.syllabusLink); break;
            case 'video': title.innerText = "Video Lecture"; frame.src = getYouTubeEmbed(window.d.videoURL); break;
            case 'pdf': title.innerText = "PDF Book"; frame.src = fixDriveLink(window.d.sourcePDF); break;
            case 'slides': title.innerText = "PPT Slides"; frame.src = "https://docs.google.com/viewer?embedded=true&url=" + encodeURIComponent(window.d.slidesURL); break;
            case 'summary': title.innerText = "Summary"; frame.style.display = "none"; textV.style.display = "block"; textV.innerHTML = `<div style="padding:10px; white-space:pre-line;">${window.d.summaryText}</div>`; break;
            case 'mindmap': title.innerText = "Mind Map"; frame.src = fixDriveLink(window.d.mindmapData); break;
            case 'quiz': title.innerText = "Quiz"; frame.src = window.d.quizData; break;
            case 'assignment': title.innerText = "Assignment"; frame.src = window.d.assignment; break;
            case 'certificate': title.innerText = "Certificate"; frame.src = fixDriveLink(window.d.Certificate); break;
            case 'audio':
                title.innerText = "Audio Podcast";
                let aUrl = window.d.audioURL;
                if(aUrl.includes("drive.google.com")) {
                    let aid = aUrl.includes("id=") ? aUrl.split("id=")[1].split("&")[0] : aUrl.split("/d/")[1].split("/")[0];
                    aUrl = `https://docs.google.com/uc?export=download&id=${aid}`;
                }
                frame.srcdoc = `<html><body style="display:flex;justify-content:center;align-items:center;height:90vh;font-family:sans-serif;background:#f9f9f9;"><div style="text-align:center;"><i class="fas fa-headphones" style="font-size:3rem;color:#FF6B35;margin-bottom:15px;"></i><br><audio controls autoplay src="${aUrl}"></audio></div><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"></body></html>`;
                break;
        }
    }
    function logout() { localStorage.clear(); window.location.href = "login.html"; }
</script>
</body>
</html>